<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wi-Fi QR Generator — Demo (Simulated Access)</title>

<!-- QR library & Firebase compat libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
  :root{
    --accent:#0ea5a3;
    --accent-dark:#067e78;
    --card:#ffffff;
    --bg:#fff9e0;
    --muted:#6b7280;
    --radius:14px;
    --glass: rgba(255,255,255,0.85);
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(135deg,#fde68a 0%, #ffd778 50%, #fff3b0 100%);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
    color:#0f172a;
  }
  .wrap{
    width:100%;
    max-width:980px;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:28px;
    align-items:start;
  }

  /* left column (auth + generate) */
  .card{
    background:var(--glass);
    border-radius:var(--radius);
    padding:20px;
    box-shadow:0 8px 30px rgba(2,6,23,0.12);
    border:1px solid rgba(0,0,0,0.06);
  }
  .brand{
    display:flex;gap:10px;align-items:center;margin-bottom:10px;
  }
  .logo{
    width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
  }
  h1{margin:6px 0 14px;font-size:20px;}
  .muted{color:var(--muted);font-size:13px;margin-bottom:16px;}

  label{display:block;font-size:13px;margin:8px 0 6px;}
  input[type="text"], input[type="email"], input[type="password"], input[type="number"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);font-size:14px;
  }

  .row{display:flex;gap:8px;align-items:center;}
  .btn{
    display:inline-block;background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(14,165,163,0.12);}

  .oauth{
    display:flex;gap:10px;margin:12px 0;
  }
  .oauth button{flex:1;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:white}

  .small{font-size:13px;color:var(--muted);}

  /* right column (design + history + preview) */
  .panel{
    background:transparent;
  }
  .preview-card{
    background:var(--card);
    border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.06);height:100%;
    display:flex;flex-direction:column;gap:14px;
  }
  .preview-top{display:flex;align-items:center;justify-content:space-between;}
  .qr-area{display:flex;gap:16px;align-items:center;}
  #qrcode{width:220px;height:220px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:8px;border:1px dashed rgba(15,23,42,0.04)}
  .info{flex:1}
  .info h3{margin:0 0 6px;font-size:16px}
  .info p{margin:0;color:var(--muted);font-size:13px}
  .history{margin-top:6px}
  .history ul{padding:0;margin:8px 0 0;list-style:none}
  .history li{padding:8px;border-radius:8px;background:#fbfbfb;margin-bottom:8px;font-size:14px;border:1px solid rgba(2,6,23,0.03)}
  .notice{font-size:13px;color:#92400e;background:#fff7ed;padding:10px;border-radius:8px}

  /* responsive */
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr;max-width:680px}
    #qrcode{width:180px;height:180px}
  }

  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline;font-weight:600}
</style>
</head>
<body>

<div class="wrap">

  <!-- left: auth / generator -->
  <div>
    <!-- AUTH CARD -->
    <div id="authCard" class="card">
      <div class="brand">
        <div class="logo">QR</div>
        <div>
          <div style="font-weight:700">Wi-Fi QR Generator</div>
          <div class="small">Login to manage QR & history</div>
        </div>
      </div>

      <!-- LOGIN VIEW -->
      <div id="loginView">
        <h1>Sign in</h1>
        <div class="muted">Use email/password or Google to continue</div>

        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="you@example.com" />

        <label>Password</label>
        <input id="loginPassword" type="password" placeholder="••••••••" />

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" onclick="login()">Sign in</button>
          <button class="btn ghost" onclick="showRegister()">Register</button>
        </div>

        <div class="oauth">
          <button id="googleBtn" onclick="googleSignIn()">Sign in with Google</button>
        </div>

        <div class="small">By signing in you can save QR generations and show them in history.</div>
      </div>

      <!-- REGISTER VIEW -->
      <div id="registerView" style="display:none">
        <h1>Create account</h1>
        <div class="muted">Quick signup — email & password</div>

        <label>Email</label>
        <input id="registerEmail" type="email" placeholder="you@example.com" />
        <label>Password</label>
        <input id="registerPassword" type="password" placeholder="At least 6 characters" />

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" onclick="register()">Create</button>
          <button class="btn ghost" onclick="showLogin()">Back</button>
        </div>
      </div>

      <!-- SIGNED-IN VIEW -->
      <div id="userView" style="display:none">
        <h1 id="welcomeUser">Welcome</h1>
        <div class="muted" id="userEmail">you@example.com</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" onclick="showGenerator()">Create QR</button>
          <button class="btn ghost" onclick="logout()">Sign out</button>
        </div>
      </div>
    </div>

    <!-- generation card -->
    <div class="card" style="margin-top:18px" id="generatorCard">
      <h3 style="margin:0 0 8px">QR & Access Settings</h3>
      <div class="small">Enter network details below. The *access time* will be recorded to Firestore and used for demo simulation or router-automation (if implemented).</div>

      <label style="margin-top:12px">SSID (Wi-Fi name)</label>
      <input id="ssid" type="text" placeholder="MyHotspot" />

      <label>Password</label>
      <input id="password" type="text" placeholder="Wi-Fi password" />

      <label>Access time (minutes)</label>
      <input id="minutes" type="number" min="1" placeholder="10" />

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="generateQR()" id="generateBtn">Generate QR</button>
        <button class="btn ghost" onclick="downloadQR()">Download</button>
      </div>

      <div style="margin-top:12px" id="demoNote" class="small">
        For presentation: if you use a phone hotspot the disconnection is <strong>simulated</strong>. In a production setup the router must enforce session time.
      </div>
    </div>

  </div>

  <!-- right: preview + history -->
  <div class="panel">
    <div class="preview-card">
      <div class="preview-top">
        <div>
          <strong>Live Preview</strong>
          <div class="small">Scan with phone to join (if network active)</div>
        </div>
        <div class="small">Status: <span id="statusP">idle</span></div>
      </div>

      <div class="qr-area" style="margin-top:6px">
        <div id="qrcode" aria-hidden="true"></div>
        <div class="info">
          <h3 id="ssidLabel">SSID —</h3>
          <p id="pwLabel" class="small">Password —</p>

          <div style="margin-top:10px">
            <div id="countdown" class="notice" style="display:none"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:6px">
        <div class="small">QR history (latest 8)</div>
        <div class="history" id="historyBox"><div class="small">No history yet.</div></div>
      </div>

      <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center">
        <div class="small">Presentation mode: <span class="link-like" onclick="showSimInfo()">how simulation works</span></div>
        <div>
          <button class="btn ghost" onclick="clearHistory()">Clear history</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ============================
   PASTE YOUR FIREBASE CONFIG
   Replace the object below with your project's config.
   Example structure:
   const firebaseConfig = {
     apiKey: "...",
     authDomain: "...",
     projectId: "...",
     storageBucket: "...",
     messagingSenderId: "...",
     appId: "..."
   };
   ============================ */
const firebaseConfig = {
  /* PASTE YOUR FIREBASE CONFIG HERE */
  apiKey: "AIzaSyChf-qZnsFv-828e4ioHh9Txm6dLV0sPys",
  authDomain: "wifiqrproject.firebaseapp.com",
  projectId: "wifiqrproject",
  storageBucket: "wifiqrproject.firebasestorage.app",
  messagingSenderId: "547895004045",
  appId: "1:547895004045:web:bcaa8d9cf04c12d0f24bc4"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* --------- UI helpers ---------- */
function el(id){return document.getElementById(id);}
function showLogin(){ el('loginView').style.display='block'; el('registerView').style.display='none'; el('userView').style.display='none'; }
function showRegister(){ el('loginView').style.display='none'; el('registerView').style.display='block'; el('userView').style.display='none'; }
function showUser(uid,email){ el('loginView').style.display='none'; el('registerView').style.display='none'; el('userView').style.display='block'; el('welcomeUser').innerText = 'Welcome'; el('userEmail').innerText = email; }
function showGenerator(){ /* reveal generator card scrolled into view */ el('generateBtn').scrollIntoView({behavior:'smooth', block:'center'}); }

/* --------- Auth --------- */
function login(){
  const email = el('loginEmail').value.trim();
  const pw = el('loginPassword').value;
  if(!email || !pw){ alert('Please enter email and password'); return; }
  auth.signInWithEmailAndPassword(email,pw).catch(e=>alert(e.message));
}
function register(){
  const email = el('registerEmail').value.trim();
  const pw = el('registerPassword').value;
  if(!email || !pw){ alert('Please enter email and password'); return; }
  auth.createUserWithEmailAndPassword(email,pw).then(()=>{ alert('Account created — you can sign in now'); showLogin(); }).catch(e=>alert(e.message));
}
function logout(){ auth.signOut(); }

/* Google Sign-In using popup */
function googleSignIn(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(e=>alert(e.message));
}

/* --------- On auth state change --------- */
auth.onAuthStateChanged(user=>{
  if(user){
    showUser(user.uid, user.email||user.displayName||'User');
    loadHistory(user.uid);
  } else {
    showLogin();
    clearPreview();
  }
});

/* --------- QR generation + saving to Firestore --------- */
let currentQRData = null;
function generateQR(){
  const ssid = el('ssid').value.trim();
  const pw = el('password').value.trim();
  const minutes = parseInt(el('minutes').value,10);

  if(!ssid || !pw || !minutes || minutes <= 0){ alert('Please complete SSID, password and valid minutes'); return; }
  // create wifi formatted string
  const wifiTag = `WIFI:T:WPA;S:${escapeSemicolons(ssid)};P:${escapeSemicolons(pw)};;`;

  // render QR
  el('qrcode').innerHTML = '';
  new QRCode(el('qrcode'), { text: wifiTag, width: 220, height: 220 });

  // update labels
  el('ssidLabel').innerText = ssid;
  el('pwLabel').innerText = 'Password: ' + pw;
  el('statusP').innerText = `QR generated — ${minutes} min access`;

  // Save to Firestore under user
  const user = auth.currentUser;
  if(!user){ alert('You must be signed in to save history'); return; }

  db.collection('users').doc(user.uid).collection('history').add({
    ssid: ssid,
    password: pw,
    access_minutes: minutes,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=> loadHistory(user.uid))
    .catch(e=>console.error('save err',e));

  // start simulated countdown for demo (does not disconnect hotspot)
  startSimulatedCountdown(minutes);
  currentQRData = {ssid, pw, minutes, createdAt:new Date()};
}

/* helper to escape semicolons in SSID/password */
function escapeSemicolons(s){ return s.replace(/;/g, '\\;'); }

/* download QR as PNG (by grabbing generated canvas or image) */
function downloadQR(){
  const container = el('qrcode');
  const img = container.querySelector('img') || container.querySelector('canvas');
  if(!img){ alert('Generate QR first'); return; }

  // if canvas, convert to dataURL; if img, use src
  let url = '';
  if(img.tagName.toLowerCase() === 'canvas') url = img.toDataURL('image/png');
  else url = img.src;

  const a = document.createElement('a');
  a.href = url;
  a.download = `wifi-${(new Date()).getTime()}.png`;
  a.click();
}

/* --------- simulated countdown --------- */
let simInterval = null;
function startSimulatedCountdown(minutes){
  clearInterval(simInterval);
  const box = el('countdown');
  let seconds = minutes * 60;
  box.style.display = 'block';
  updateSimUI();

  simInterval = setInterval(()=>{
    seconds--;
    updateSimUI();
    if(seconds <= 0){
      clearInterval(simInterval);
      box.innerText = 'Access time ended (simulation).';
      el('statusP').innerText = 'simulated expired';
    }
  },1000);

  function updateSimUI(){
    const m = Math.floor(seconds/60), s = seconds%60;
    box.innerText = `Simulated remaining: ${m}m ${s}s — (presentation only)`;
  }
}

/* --------- history load/clear --------- */
function loadHistory(uid){
  const box = el('historyBox');
  box.innerHTML = '<div class="small">Loading...</div>';
  db.collection('users').doc(uid).collection('history')
    .orderBy('createdAt','desc').limit(8).get()
    .then(snap=>{
      if(snap.empty){ box.innerHTML = '<div class="small">No history yet.</div>'; return; }
      const ul = document.createElement('ul');
      snap.forEach(doc=>{
        const d = doc.data();
        const ts = d.createdAt ? d.createdAt.toDate().toLocaleString() : '-';
        const li = document.createElement('li');
        li.innerHTML = `<strong>${escapeHtml(d.ssid)}</strong> — ${escapeHtml(d.access_minutes)} min <br><small>${escapeHtml(ts)}</small>`;
        ul.appendChild(li);
      });
      box.innerHTML = '';
      box.appendChild(ul);
    }).catch(e=>{ box.innerHTML = '<div class="small">Error loading history</div>'; console.error(e); });
}

function clearHistory(){
  const user = auth.currentUser;
  if(!user){ alert('Sign in first'); return; }
  if(!confirm('Clear your history? This cannot be undone.')) return;
  // fetch and delete (small number)
  db.collection('users').doc(user.uid).collection('history').get()
    .then(snap=>{
      const batch = db.batch();
      snap.forEach(doc=> batch.delete(doc.ref));
      return batch.commit();
    }).then(()=> loadHistory(user.uid))
    .catch(e=> alert('Error clearing history: '+e.message));
}

/* --------- util --------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* show info about simulation */
function showSimInfo(){
  alert('Presentation simulation: This timer is only visual. If you use a phone hotspot the device will not be forcibly disconnected by this web app. In a real deployment you would configure the router/access point (MikroTik/OpenWRT/UniFi) or use a captive portal to enforce session duration automatically.');
}

/* clear preview on sign out */
function clearPreview(){
  el('qrcode').innerHTML = '';
  el('ssidLabel').innerText = 'SSID —';
  el('pwLabel').innerText = 'Password —';
  el('statusP').innerText = 'idle';
  el('historyBox').innerHTML = '<div class="small">No history</div>';
}
</script>
</body>
</html>
